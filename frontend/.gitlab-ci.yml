variables:
    USER_PROJECT: "onlineshop"
    PROJECT_NAME: "onlineshopfrontend"
    IMAGE_VERSION: "onlineshopfrontend:done_frontend_cad371bf"
    # IMAGE_VERSION: "${PROJECT_NAME}:${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}"
    CODECLIMATE_REPORT: "codeclimate_analysis_${PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}_report"
    SNYKSCAN_REPORT: "snyk_scan_${PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}_report"
    TRIVYFS_REPORT: "trivyfs_scan_${PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}_report"
    TRIVY_IMAGE_REPORT: "security_scan_image_${PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}_report"
    ARACHNI_WEBSITE_REPORT: "security_scan_website_${PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}_report"
    ADDRESS_FRONTEND: "http://online-shop.hoanglee.id.vn:3000/"
    SNYKSCAN_FILE: "snyk_scan_onlineshopfrontend_done_frontend_cad371bf_report"
    TRIVY_FILE: "security_scan_image_onlineshopfrontend_done_frontend_cad371bf_report"
    ARACHNI_WEBSITE_FILE: "security_scan_website_onlineshopfrontend_done_frontend_cad371bf_report"
    FE_PORT: "3000"

stages:
    - build
    - test source code
    - security scan image
    - deploy
    - security scan website
    - performace testing

# build:
#     stage: build
#     variables:
#         GIT_STRATEGY: clone
#     script:
#         - docker build -t $IMAGE_VERSION .
#     tags:
#         - online-shop-runner-dev-shell
#     only:
#         - tags

# codeclimate analyze:
#     stage: test source code
#     variables:
#         GIT_STRATEGY: none
#     script:
#         - docker run --rm --env CODECLIMATE_CODE="$PWD" --volume "$PWD":/code --volume /var/run/docker.sock:/var/run/docker.sock --volume /tmp/cc:/tmp/cc codeclimate/codeclimate analyze -f html > $CODECLIMATE_REPORT.html
#     after_script:
#         - sudo chown -R gitlab-runner $(pwd)
#     tags:
#         - online-shop-runner-dev-shell
#     only:
#         - tags
#     artifacts:
#         paths:
#         - $CODECLIMATE_REPORT.html
#         expire_in: 1 day

# trivyfs scan:
#     stage: test source code
#     variables:
#         GIT_STRATEGY: clone
#     script:
#         - docker run --rm -v $PWD:/${PROJECT_NAME} -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy fs /${PROJECT_NAME} --severity HIGH,CRITICAL --format template --template "@contrib/html.tpl" --output /${PROJECT_NAME}/$TRIVYFS_REPORT.html
#     after_script:
#         - sudo chown -R gitlab-runner $(pwd)
#     tags:
#         - online-shop-runner-dev-shell
#     only:
#         - tags
#     artifacts:
#         paths:
#         - $TRIVYFS_REPORT.html
#         expire_in: 1 day

# snyk scan:
#     stage: test source code
#     variables:
#         GIT_STRATEGY: clone
#     script:
#         - snyk test --json | snyk-to-html -o $SNYKSCAN_FILE.html
#     tags:
#         - online-shop-runner-dev-shell
#     only:
#         - tags
#     artifacts:
#         paths:
#         - $SNYKSCAN_FILE.html
#         expire_in: 1 day

# trivy scan image:
#     stage: security scan image
#     variables:
#         GIT_STRATEGY: none
#     script:
#         - docker run --rm -v $(pwd):/${PROJECT_NAME} -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image clean --all
#         - docker run --rm -v $(pwd):/${PROJECT_NAME} -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --format template --template "@contrib/html.tpl" --output /${PROJECT_NAME}/${TRIVY_FILE}.html $IMAGE_VERSION
#     after_script:
#         - sudo chown -R gitlab-runner $(pwd)
#     tags:
#         - online-shop-runner-dev-shell
#     only:
#         - tags
#     artifacts:
#         paths:
#         - ${TRIVY_FILE}.html
#         expire_in: 1 day

deploy:
    stage: deploy
    variables:
        GIT_STRATEGY: none
    script:
        - sudo su ${USER_PROJECT} -c "docker rm -f $PROJECT_NAME; docker run --name $PROJECT_NAME -dp $FE_PORT $IMAGE_VERSION"
    tags:
        - online-shop-runner-dev-shell
    only:
        - tags

security scan website:
    stage: security scan website
    variables:
        GIT_STRATEGY: none
    script:
        - docker run --rm -v /tmp/:/tmp/ devopseduvn/arachni:v1.4-0.5.10 bin/arachni --output-verbose --scope-include-subdomains $ADDRESS_FRONTEND --report-save-path=/tmp/$ARACHNI_WEBSITE_FILE.afr > /dev/null 2>&1
        - docker run --rm -v /tmp/:/tmp/ devopseduvn/arachni:v1.4-0.5.10 bin/arachni_reporter /tmp/$ARACHNI_WEBSITE_FILE.afr --reporter=html:outfile=/tmp/$ARACHNI_WEBSITE_FILE.html.zip
        - sudo chmod 777 /tmp/$ARACHNI_WEBSITE_FILE.html.zip
        - cp /tmp/$ARACHNI_WEBSITE_FILE.html.zip .
    after_script:
        - sudo chown -R gitlab-runner $(pwd)
    tags:
        - online-shop-runner-dev-shell
    only:
        - tags
    artifacts:
        paths:
        - $ARACHNI_WEBSITE_FILE.html.zip
        expire_in: 1 day